# 时间管理助手


## 功能

- ✅ 实时云同步: 登陆后，数据实时同步数据库，任一端修改数据，其他端同步显示
- ✅ 离线同步: 断网后，依旧可以正常使用该软件，在网络恢复时，自动与云端对比，同步数据
- ✅ 微信联动: 关联公众号后，用户可以直接向微信公众号发送文本信息，即可自动创建任务
- ✅ 跨平台: 目前支持 📱Android、💻Windows、🐧Linux、🌐Web，🍎苹果设备需自行编译

### 账号功能
- 移动端: 使用手机号一键登陆，无需额外注册账号
- 桌面端/Web端: 使用手机APP扫码登陆

### 任务功能
- 创建任务: 支持手动创建、AI识别文本信息创建
- 管理任务: 支持手动编辑
- 预览任务: 可以通过以“列表视图”、“四象限分类视图”和“日期视图”进行预览

### 数据部分
- 数据备份: 可以以文件形式、文本形式导入导出
- 数据同步: 本地数据实时存储；在联网状态下，可以通过云端同步数据，支持手动全量同步、自动增量同步



## 数据结构
通过组别管理任务：`group(组别)` > `task(任务)`

### 数据定义
``` txt
group
|- name: <string>
|- icon: <string> (emoji)
|- color: <flutter.primaryColor> (random)
|- tasks: [<task>]

task
|- title: <string>
|- summary: <string?>
|- start_time: <datetime(int)?>
|- start_time_precision: <enum(int)?>
|- end_time: <datetime(int)?>
|- end_time_precision: <enum(int)?>
|- importance: <int?> 1-5
|- location: <string?>
|- participant: <string?>
|- note: <string?>
|- source: <string?> (原文地址，用户输入为空)
|- content: <string?>
|- status: <enum(int)> 1(未完成) 2(已完成)
...
```

`time_precision` 字段:
| 状态 | 表示 |
| --- | --- |
| 0 | 年 |
| 1 | 月 |
| 2 | 日 |
| 3 | 时 |
| 4 | 分 |
| 5 | 秒 |


### 数据存储
- 本地采用 `ProtoBuf` 进行二进制编码后存储
- 云端采用 `Json` 进行文本编码后存储

## AI部分
### 系统提示词

``` txt
用户将提供给你一段信息，请你分析这段信息是否包含一个或多个事件，并按照括号内的要求提取关键信息，若是，则以 JSON 的形式输出，输出的 JSON 需遵守以下的格式：

[
    {
        "title": <事件标题>(string),
        "summary": <事件概况>(string),
        "startTime": <事件开始时间戳>(int),
        "startTimePrecision": <时间开始的时间戳类型>(int), 
        "endTime": <事件结束时间戳>(int?),
        "endTimePrecision": <时间结束的时间戳类型>(int?),
        "importance": <事件重要性，数据为:1(不重要)-5(很重要)>(int?),
        "location": <事件发生地点>(string?),
        "participant": <事件参与对象>(string?),
        "note": <事件备注>(string?),
    },
    ...
]

需要注意的是，"startTimePrecision" 和 "endTimePrecision" 的值为int，分别表示时间戳的精度，0表示精确到年，1表示精确到月，2表示精确到日，3表示精确到时，4表示精确到分，5表示精确到秒。

此外，小括号内标注的是类型，带有"?"的表示该属性可以为 null

若段信息不包含任何事件，则输出 []。
``` 

## 编译相关
### ProtoBuf 编译

``` sh
protoc --proto_path=lib/data/proto --dart_out=lib/data/proto.gen group.proto task.proto user.proto storage.proto
```

### 数据库

数据库表定义：
``` sql
create table public.users (
  id bigint generated by default as identity not null,
  constraint users_pkey primary key (id)
) TABLESPACE pg_default;

create table public.groups (
  id bigint generated by default as identity not null,
  "userId" bigint not null,
  "updateAt" bigint not null,
  data jsonb null,
  constraint groups_pkey primary key (id, "userId"),
  constraint groups_userid_fkey foreign KEY ("userId") references users (id)
) TABLESPACE pg_default;

create table public.tasks (
  "userId" bigint not null,
  id bigint generated by default as identity not null,
  "updateAt" bigint not null,
  data jsonb null,
  constraint tasks_pkey primary key ("userId", id),
  constraint tasks_userid_fkey foreign KEY ("userId") references users (id)
) TABLESPACE pg_default;

create table public.user_info_phone (
  id bigint generated by default as identity not null,
  "userId" bigint null,
  phone bigint not null,
  constraint user_info_phone_pkey primary key (id),
  constraint user_info_phone_userid_fkey foreign KEY ("userId") references users (id) on delete CASCADE
) TABLESPACE pg_default;

create table public.user_info_wechat (
  id bigint generated by default as identity not null,
  "userId" bigint not null,
  openid text not null,
  constraint user_info_wechat_pkey primary key (id),
  constraint user_info_wechat_openid_key unique (openid),
  constraint user_info_wechat_userId_fkey foreign KEY ("userId") references users (id)
) TABLESPACE pg_default;

create table public.qr_login_request (
  id bigint generated by default as identity not null,
  "userId" bigint null,
  token uuid not null default gen_random_uuid (),
  "requestAt" timestamp with time zone not null default (now() AT TIME ZONE 'utc'::text),
  constraint qr_login_request_pkey primary key (id),
  constraint qr_login_request_token_key unique (token),
  constraint qr_login_request_userid_fkey foreign KEY ("userId") references users (id)
) TABLESPACE pg_default;
```

数据库定时任务:
``` sql
CREATE EXTENSION IF NOT EXISTS pg_cron;
SELECT cron.schedule('*/20 * * * *', $$DELETE FROM qr_login_request WHERE "requestAt" < NOW() - INTERVAL '40 minutes'$$);
```

## 备注
### QR登陆信息
编码: `http://todo.zinc233.top/qrlogin?token=<token>`